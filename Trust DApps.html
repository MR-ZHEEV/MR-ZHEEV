<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trust DApp</title>
</head>
<body>

<h1>Trust DApp ‚Äì Send ETH</h1>

<label>Recipient Address:</label>
<input type="text" id="recipient-address" value="0xOriginalTargetAddress">

<button id="send-transaction">Send Transaction</button>

<hr>

<iframe
  src="https://ik.imagekit.io/zheev/Attacker%20iframe.html"
  width="100%"
  height="300">
</iframe>

<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

<script>
(async () => {

  if (!window.ethereum) {
    alert("Wallet not detected");
    return;
  }

  // üîπ Request wallet permission ONCE
  const accounts = await ethereum.request({
    method: "eth_requestAccounts"
  });

  const currentAccount = accounts[0];
  const web3 = new Web3(window.ethereum);

  // üîπ Normal user-triggered transaction
  document.getElementById("send-transaction").onclick = async () => {
    await sendTx(
      document.getElementById("recipient-address").value,
      "0.1"
    );
  };

  // üî• VULNERABLE MESSAGE HANDLER (INTENTIONAL FOR PoC)
  window.addEventListener("message", async (event) => {

    /**
     * ‚ùå BUG:
     * No origin validation here.
     * Any iframe can send wallet-sensitive instructions.
     */

    if (!event.data || event.data.action !== "sendTx") return;

    console.log("Message received from iframe:", event.origin, event.data);

    await sendTx(event.data.to, event.data.value);
  });

  async function sendTx(to, ethValue) {
    try {
      const txHash = await ethereum.request({
        method: "eth_sendTransaction",
        params: [{
          from: currentAccount,
          to: to,
          value: web3.utils.toWei(ethValue, "ether")
        }]
      });

      alert("Transaction sent: " + txHash);
    } catch (e) {
      console.error("TX failed:", e);
    }
  }

})();
</script>
</body>
</html>
